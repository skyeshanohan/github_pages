<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Manager Details - Repository Ownership Tracker</title>
    
    <!-- Preconnect to CDN for faster loading -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- CoreUI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@coreui/coreui@4.3.0/dist/css/coreui.min.css">
    <!-- CoreUI Icons -->
    <link rel="stylesheet" href="https://unpkg.com/@coreui/icons@2.1.0/css/all.min.css">
    
    <!-- Preload data file -->
    <link rel="preload" href="data/repositories.json" as="fetch" crossorigin>
    <link rel="prefetch" href="data/pod-managers.yaml" as="fetch">
    
    <style>
        :root {
            --cui-body-bg: #f5f7fa;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-sidebar: #495057;
            --text-sidebar-active: #321fdb;
            --border-color: #e9ecef;
            --hover-bg: #f8f9fa;
        }

        body.dark-mode {
            --cui-body-bg: #0d1117;
            --bg-primary: #161b22;
            --bg-secondary: #21262d;
            --bg-sidebar: #161b22;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-sidebar: #c9d1d9;
            --text-sidebar-active: #58a6ff;
            --border-color: #30363d;
            --hover-bg: #21262d;
            background-color: var(--cui-body-bg);
            color: var(--text-primary);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--cui-body-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .dark-mode .card,
        .dark-mode .navbar {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            background: linear-gradient(180deg, var(--bg-sidebar) 0%, var(--bg-secondary) 100%);
            transition: background-color 0.3s, color 0.3s;
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .dark-mode .sidebar {
            background: linear-gradient(180deg, var(--bg-sidebar) 0%, #1a1e24 100%);
            box-shadow: 2px 0 8px rgba(0,0,0,0.3);
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-sidebar);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .sidebar-brand:hover {
            color: var(--text-sidebar-active);
        }

        .sidebar-brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #321fdb 0%, #6366f1 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
        }

        .sidebar-section-title {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .sidebar .nav-link {
            color: var(--text-sidebar) !important;
            transition: all 0.2s;
            padding: 0.75rem 1rem !important;
            margin: 0.125rem 0.5rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        .sidebar .nav-link:hover {
            background-color: var(--hover-bg);
            color: var(--text-sidebar-active) !important;
            transform: translateX(2px);
        }

        .sidebar .nav-link.active {
            background: linear-gradient(90deg, rgba(50, 31, 219, 0.1) 0%, transparent 100%);
            color: var(--text-sidebar-active) !important;
            border-left: 3px solid var(--text-sidebar-active);
            font-weight: 500;
        }

        .dark-mode .sidebar .nav-link.active {
            background: linear-gradient(90deg, rgba(88, 166, 255, 0.15) 0%, transparent 100%);
        }

        .sidebar .nav-icon {
            color: inherit;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-sidebar);
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .nav-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.5rem 1rem;
        }

        .sidebar-minimized {
            width: 56px;
        }

        .sidebar-expanded {
            width: 256px;
        }

        .main {
            margin-left: 256px;
            transition: margin-left 0.25s;
        }

        .main.sidebar-collapsed {
            margin-left: 56px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.25s;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main {
                margin-left: 0;
            }
        }

        .navbar {
            background-color: var(--bg-primary) !important;
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand,
        .navbar-text {
            color: var(--text-primary) !important;
        }

        .stats-card {
            border-left: 4px solid #321fdb;
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: var(--bg-primary);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .stats-card .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .dark-mode .stats-card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
        }

        .dark-mode .stats-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border-left-color: #58a6ff;
        }

        .badge-custom {
            padding: 0.35em 0.65em;
            font-weight: 500;
        }

        .breadcrumb-container {
            background: var(--bg-secondary);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .breadcrumb {
            margin-bottom: 0;
            background: transparent;
            padding: 0;
        }

        .breadcrumb-item a {
            color: var(--text-sidebar-active);
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .breadcrumb-item a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .breadcrumb-item.active {
            color: var(--text-primary);
        }

        /* Quick Lookup Bar */
        .quick-lookup-container {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }

        .quick-lookup-wrapper {
            max-width: 600px;
            position: relative;
        }

        .quick-lookup-input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .quick-lookup-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .quick-lookup-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }

        .dark-mode .quick-lookup-suggestions {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .quick-lookup-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: var(--hover-bg);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-icon {
            color: var(--text-sidebar-active);
        }

        .table-container {
            overflow-x: auto;
        }

        .repo-link {
            color: inherit;
            text-decoration: none;
        }

        .repo-link:hover {
            color: #321fdb;
            text-decoration: underline;
        }

        .dark-mode .repo-link:hover {
            color: #58a6ff;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar sidebar-expanded" id="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="sidebar-brand">
                <div class="sidebar-brand-icon">
                    <i class="cil-code"></i>
                </div>
                <span>Repo Tracker</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <ul class="nav">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html">
                        <i class="nav-icon cil-speedometer"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="nav-icon cil-list"></i> Repository Table
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="stats.html">
                        <i class="nav-icon cil-chart"></i> Statistics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="health.html">
                        <i class="nav-icon cil-heart"></i> Health
                    </a>
                </li>
                <div class="nav-divider"></div>
                <li class="sidebar-section">
                    <div class="sidebar-section-title">Verticals</div>
                    <ul class="nav" id="verticalNavLinks"></ul>
                </li>
                <div class="nav-divider"></div>
                <li class="nav-item">
                    <a class="nav-link" href="about.html">
                        <i class="nav-icon cil-info"></i> About
                    </a>
                </li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <div>Â© 2024</div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main" id="main">
        <!-- Header -->
        <header class="navbar navbar-expand navbar-light bg-white border-bottom">
            <div class="container-fluid">
                <button class="btn btn-link d-md-none" id="sidebarToggle">
                    <i class="cil-menu"></i>
                </button>
                <h4 class="navbar-brand mb-0" id="pageTitle">Engineering Manager Details</h4>
                <div class="navbar-nav ms-auto">
                    <button class="btn btn-sm btn-outline-secondary me-2" id="darkModeToggle" title="Toggle dark mode">
                        <i class="cil-moon"></i>
                    </button>
                    <span class="navbar-text">
                        <i class="cil-github"></i> GitHub Pages
                    </span>
                </div>
            </div>
        </header>

        <!-- Quick Lookup Bar -->
        <div class="quick-lookup-container">
            <div class="container-fluid">
                <div class="quick-lookup-wrapper">
                    <i class="cil-magnifying-glass quick-lookup-icon"></i>
                    <input type="text" class="quick-lookup-input" id="quickLookupInput" placeholder="Search pods, managers, or verticals... (e.g., 'Vertical1-Pod1' or 'Sarah Johnson')" autocomplete="off">
                    <div class="quick-lookup-suggestions" id="quickLookupSuggestions"></div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="body flex-grow-1 p-3">
            <!-- Breadcrumbs -->
            <nav aria-label="breadcrumb" class="breadcrumb-container" id="breadcrumbNav">
                <ol class="breadcrumb mb-0">
                </ol>
            </nav>

            <div class="loading-spinner" id="loadingSpinner" style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div id="content" class="d-none">
                <!-- Manager Header -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div>
                                <h2 class="mb-1" id="managerName">-</h2>
                                <p class="text-muted mb-0" id="managerInfo">Cross-vertical repository ownership and security information</p>
                            </div>
                            <div class="text-end">
                                <div class="fs-3 fw-bold" id="totalReposCount">-</div>
                                <div class="text-muted small">Repositories</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cross-Vertical Totals -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <strong><i class="cil-shield-alt"></i> Total Security Findings (Across All Verticals)</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-4 justify-content-center">
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #e55353;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="totalIssues">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">Total Issues</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #e55353;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="criticalTotal">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">Critical</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #f9b115;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="highTotal">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">High</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #39afd1;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="sastTotal">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">SAST</div>
                                        <div class="text-muted small">Static Analysis</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #f9b115;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="scaTotal">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">SCA</div>
                                        <div class="text-muted small">Dependency Scan</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #8750de;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="secretsTotal">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">Secrets</div>
                                        <div class="text-muted small">Secret Scanning</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New vs Remediated (30 Days) -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <strong><i class="cil-chart-line"></i> New vs Remediated (Last 30 Days - Across All Verticals)</strong>
                        <div class="btn-group btn-group-sm" role="group" id="severityFilterGroup">
                            <input type="radio" class="btn-check" name="severityFilter" id="filterAll" value="all" checked>
                            <label class="btn btn-outline-light" for="filterAll">All</label>
                            <input type="radio" class="btn-check" name="severityFilter" id="filterCriticalHigh" value="critical-high">
                            <label class="btn btn-outline-light" for="filterCriticalHigh">Critical + High</label>
                            <input type="radio" class="btn-check" name="severityFilter" id="filterCritical" value="critical">
                            <label class="btn btn-outline-light" for="filterCritical">Critical</label>
                            <input type="radio" class="btn-check" name="severityFilter" id="filterHigh" value="high">
                            <label class="btn btn-outline-light" for="filterHigh">High</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3 justify-content-center">
                            <div class="col-sm-6 col-md-3 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #e55353;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="newFindings30">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">New Findings</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-3 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #2eb85c;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="remediated30">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">Remediated</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-3 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #39afd1;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="netChange30">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">Net Change</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-3 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #8750de;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="remediationRate30">0%</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">Remediation Rate</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th class="text-center">New</th>
                                        <th class="text-center">Remediated</th>
                                        <th class="text-center">Net Change</th>
                                    </tr>
                                </thead>
                                <tbody id="newVsRemediatedTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Breakdown by Vertical -->
                <div class="card mb-4">
                    <div class="card-header">
                        <strong><i class="cil-folder"></i> Breakdown by Vertical</strong>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Vertical</th>
                                        <th class="text-center">Repos</th>
                                        <th class="text-center">SAST</th>
                                        <th class="text-center">SCA</th>
                                        <th class="text-center">Secrets</th>
                                        <th class="text-center">Critical</th>
                                        <th class="text-center">High</th>
                                        <th class="text-center">Total Issues</th>
                                    </tr>
                                </thead>
                                <tbody id="verticalBreakdownTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Breakdown by Pod -->
                <div class="card mb-4">
                    <div class="card-header">
                        <strong><i class="cil-layers"></i> Breakdown by Pod</strong>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Pod</th>
                                        <th class="text-center">Vertical</th>
                                        <th class="text-center">Repos</th>
                                        <th class="text-center">SAST</th>
                                        <th class="text-center">SCA</th>
                                        <th class="text-center">Secrets</th>
                                        <th class="text-center">Critical</th>
                                        <th class="text-center">High</th>
                                        <th class="text-center">Total Issues</th>
                                    </tr>
                                </thead>
                                <tbody id="podBreakdownTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Repositories Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>All Repositories (Across All Verticals)</strong>
                        <div class="d-flex align-items-center gap-2">
                            <span id="repoCount" class="badge bg-secondary"></span>
                            <button class="btn btn-sm btn-primary" onclick="exportData('csv')">
                                <i class="cil-save"></i> Export CSV
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportData('json')">
                                <i class="cil-save"></i> Export JSON
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Organization</th>
                                        <th>Repository</th>
                                        <th>Pod</th>
                                        <th>Vertical</th>
                                        <th>Security</th>
                                        <th>Last Activity</th>
                                        <th>Language</th>
                                    </tr>
                                </thead>
                                <tbody id="repositoriesTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CoreUI JS -->
    <script src="https://unpkg.com/@coreui/coreui@4.3.0/dist/js/coreui.bundle.min.js" defer></script>
    
    <script>
        let allRepos = [];
        let managerName = '';
        let managerRepos = [];
        let podManagers = {};

        // Get manager name from URL
        function getManagerFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('name') || '';
        }

        // Normalize repositories
        function normalizeRepositories(repos) {
            return (repos || []).filter(repo => repo.status !== 'archived').map(repo => {
                const normalized = { ...repo };
                let podArray = [];
                if (Array.isArray(normalized.pod)) {
                    podArray = normalized.pod.filter(p => p && p.trim() && p !== 'No Pod Selected');
                } else if (typeof normalized.pod === 'string') {
                    podArray = normalized.pod.split(',').map(p => p.trim()).filter(p => p && p !== 'No Pod Selected');
                }
                normalized.pod = podArray.length > 0 ? podArray[0] : 'No Pod Selected';
                normalized._allPods = podArray;
                
                const allVerticals = new Set();
                podArray.forEach(pod => {
                    if (pod && pod.includes('-')) {
                        const parts = pod.split('-');
                        const vertical = parts.slice(0, -1).join('-');
                        if (vertical) allVerticals.add(vertical);
                    }
                });
                if (normalized.vertical && normalized.vertical.trim() && normalized.vertical !== 'No Vertical Identified') {
                    allVerticals.add(normalized.vertical);
                }
                normalized._allVerticals = Array.from(allVerticals);
                
                if (!normalized.vertical || !normalized.vertical.trim()) {
                    if (allVerticals.size > 0) {
                        normalized.vertical = Array.from(allVerticals)[0];
                    } else if (normalized.pod && normalized.pod.includes('-') && normalized.pod !== 'No Pod Selected') {
                        const parts = normalized.pod.split('-');
                        normalized.vertical = parts.slice(0, -1).join('-') || '';
                    } else {
                        normalized.vertical = 'No Vertical Identified';
                    }
                }

                const allManagers = new Set();
                if (podManagers && Object.keys(podManagers).length > 0) {
                    podArray.forEach(pod => {
                        if (pod && podManagers[pod]) {
                            allManagers.add(podManagers[pod]);
                        }
                    });
                }
                if (normalized.engineeringManager && normalized.engineeringManager.trim()) {
                    allManagers.add(normalized.engineeringManager.trim());
                }
                normalized._allManagers = Array.from(allManagers);
                if (!normalized.engineeringManager && allManagers.size > 0) {
                    normalized.engineeringManager = Array.from(allManagers)[0];
                }
                if (!normalized.status) normalized.status = 'active';
                return normalized;
            });
        }

        // Load Pod -> Engineering Manager mapping
        async function loadPodManagers() {
            try {
                const res = await fetch('data/pod-managers.yaml');
                if (!res.ok) return;
                const yaml = await res.text();
                podManagers = parseSimpleYamlMap(yaml);
            } catch {}
        }

        function parseSimpleYamlMap(text) {
            const map = {};
            if (!text) return map;
            const lines = text.split(/\r?\n/);
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) continue;
                const idx = trimmed.indexOf(':');
                if (idx === -1) continue;
                const key = trimmed.slice(0, idx).trim();
                let value = trimmed.slice(idx + 1).trim();
                if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
                    value = value.slice(1, -1);
                }
                if (key) map[key] = value;
            }
            return map;
        }

        // Load data
        async function loadData() {
            try {
                await loadPodManagers();
                const response = await fetch('data/repositories.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                allRepos = normalizeRepositories(data.repositories || []);
                
                managerName = decodeURIComponent(getManagerFromURL());
                if (!managerName) {
                    showError('No engineering manager specified');
                    return;
                }

                // Find all pods assigned to this manager
                const managerPods = [];
                if (podManagers && Object.keys(podManagers).length > 0) {
                    Object.entries(podManagers).forEach(([pod, assignedManager]) => {
                        if (assignedManager && assignedManager.trim() === managerName) {
                            managerPods.push(pod);
                        }
                    });
                }

                // Filter repositories - only count repos that belong to this manager's pods
                managerRepos = allRepos.filter(repo => {
                    const repoPods = repo._allPods && Array.isArray(repo._allPods) ? repo._allPods : (repo.pod ? [repo.pod] : []);
                    return repoPods.some(repoPod => managerPods.includes(repoPod));
                });
                
                if (managerRepos.length === 0) {
                    showError(`No repositories found for engineering manager: ${escapeHtml(managerName)}`);
                    return;
                }

                renderManagerDetails(managerPods);
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error loading data. Please ensure data/repositories.json exists.');
            }
        }

        function renderManagerDetails(managerPods) {
            document.getElementById('loadingSpinner').classList.add('d-none');
            document.getElementById('content').classList.remove('d-none');

            document.getElementById('pageTitle').textContent = managerName;
            document.getElementById('managerName').textContent = managerName;
            document.getElementById('totalReposCount').textContent = managerRepos.length;
            document.getElementById('repoCount').textContent = `${managerRepos.length} ${managerRepos.length === 1 ? 'repository' : 'repositories'}`;

            document.getElementById('managerInfo').textContent = `Manages ${managerPods.length} pod(s) across all verticals`;

            // Update breadcrumbs
            updateBreadcrumbs();

            // Calculate statistics
            calculateManagerStats(managerPods);

            // Render breakdown tables
            renderVerticalBreakdown();
            renderPodBreakdown(managerPods);

            // Render repositories table
            renderRepositoriesTable();
        }

        let currentSeverityFilter = 'all';

        function calculateManagerStats(managerPods) {
            let totalIssues = 0;
            let totalCritical = 0;
            let totalHigh = 0;
            let totalMedium = 0;
            let totalLow = 0;
            let totalInfo = 0;
            let totalSAST = 0;
            let totalSCA = 0;
            let totalSecrets = 0;
            
            let newSAST = 0, newSCA = 0, newSecrets = 0;
            let remediatedSAST = 0, remediatedSCA = 0, remediatedSecrets = 0;

            managerRepos.forEach(repo => {
                const vulns = repo.vulnerabilities;
                if (!vulns) return;

                const codeScanning = vulns.codeScanning || {};
                const dependabot = vulns.dependabot || {};
                const secretScanning = vulns.secretScanning || {};

                const repoSAST = codeScanning.total || 0;
                const repoSCA = dependabot.total || 0;
                const repoSecrets = secretScanning.total || 0;
                const repoIssues = repoSAST + repoSCA + repoSecrets;
                const repoCritical = (codeScanning.critical || 0) + (dependabot.critical || 0);
                const repoHigh = (codeScanning.high || 0) + (dependabot.high || 0);

                totalIssues += repoIssues;
                totalSAST += repoSAST;
                totalSCA += repoSCA;
                totalSecrets += repoSecrets;

                totalCritical += repoCritical;
                totalHigh += repoHigh;
                totalMedium += (codeScanning.medium || 0) + (dependabot.medium || 0);
                totalLow += (codeScanning.low || 0) + (dependabot.low || 0);
                totalInfo += (codeScanning.info || 0) + (dependabot.info || 0);

                // Use actual severity breakdown for New vs Remediated counts
                const sastOpened = codeScanning.openedLast30DaysBySeverity || {};
                const sastClosed = codeScanning.closedLast30DaysBySeverity || {};
                const scaOpened = dependabot.openedLast30DaysBySeverity || {};
                const scaClosed = dependabot.closedLast30DaysBySeverity || {};
                
                if (currentSeverityFilter === 'all') {
                    newSAST += codeScanning.openedLast30Days || 0;
                    newSCA += dependabot.openedLast30Days || 0;
                    newSecrets += secretScanning.openedLast30Days || 0;
                    remediatedSAST += codeScanning.closedLast30Days || 0;
                    remediatedSCA += dependabot.closedLast30Days || 0;
                    remediatedSecrets += secretScanning.closedLast30Days || 0;
                } else if (currentSeverityFilter === 'critical') {
                    newSAST += sastOpened.critical || 0;
                    newSCA += scaOpened.critical || 0;
                    newSecrets += 0; // Secrets don't have severity
                    remediatedSAST += sastClosed.critical || 0;
                    remediatedSCA += scaClosed.critical || 0;
                    remediatedSecrets += 0;
                } else if (currentSeverityFilter === 'high') {
                    newSAST += sastOpened.high || 0;
                    newSCA += scaOpened.high || 0;
                    newSecrets += 0;
                    remediatedSAST += sastClosed.high || 0;
                    remediatedSCA += scaClosed.high || 0;
                    remediatedSecrets += 0;
                } else if (currentSeverityFilter === 'critical-high') {
                    newSAST += (sastOpened.critical || 0) + (sastOpened.high || 0);
                    newSCA += (scaOpened.critical || 0) + (scaOpened.high || 0);
                    newSecrets += 0;
                    remediatedSAST += (sastClosed.critical || 0) + (sastClosed.high || 0);
                    remediatedSCA += (scaClosed.critical || 0) + (scaClosed.high || 0);
                    remediatedSecrets += 0;
                }
            });

            // Update cards
            document.getElementById('totalIssues').textContent = totalIssues;
            document.getElementById('criticalTotal').textContent = totalCritical;
            document.getElementById('highTotal').textContent = totalHigh;
            document.getElementById('sastTotal').textContent = totalSAST;
            document.getElementById('scaTotal').textContent = totalSCA;
            document.getElementById('secretsTotal').textContent = totalSecrets;

            // New vs Remediated
            const totalNew = newSAST + newSCA + newSecrets;
            const totalRemediated = remediatedSAST + remediatedSCA + remediatedSecrets;
            const netChange = totalNew - totalRemediated;
            const remediationRate = totalNew > 0 ? Math.round((totalRemediated / totalNew) * 100) : 0;

            document.getElementById('newFindings30').textContent = totalNew;
            document.getElementById('remediated30').textContent = totalRemediated;
            document.getElementById('netChange30').textContent = netChange > 0 ? `+${netChange}` : netChange;
            document.getElementById('netChange30').style.color = netChange > 0 ? '#e55353' : '#2eb85c';
            document.getElementById('remediationRate30').textContent = `${remediationRate}%`;

            renderNewVsRemediatedTable(newSAST, remediatedSAST, newSCA, remediatedSCA, newSecrets, remediatedSecrets);
        }

        function renderNewVsRemediatedTable(newSAST, remediatedSAST, newSCA, remediatedSCA, newSecrets, remediatedSecrets) {
            const tbody = document.getElementById('newVsRemediatedTable');
            const totalNew = newSAST + newSCA + newSecrets;
            const totalRemediated = remediatedSAST + remediatedSCA + remediatedSecrets;
            const totalNet = totalNew - totalRemediated;

            tbody.innerHTML = `
                <tr>
                    <td><strong>SAST</strong></td>
                    <td class="text-center">${newSAST}</td>
                    <td class="text-center"><span class="text-success">${remediatedSAST}</span></td>
                    <td class="text-center">${newSAST - remediatedSAST > 0 ? `+${newSAST - remediatedSAST}` : newSAST - remediatedSAST}</td>
                </tr>
                <tr>
                    <td><strong>SCA</strong></td>
                    <td class="text-center">${newSCA}</td>
                    <td class="text-center"><span class="text-success">${remediatedSCA}</span></td>
                    <td class="text-center">${newSCA - remediatedSCA > 0 ? `+${newSCA - remediatedSCA}` : newSCA - remediatedSCA}</td>
                </tr>
                <tr>
                    <td><strong>Secrets</strong></td>
                    <td class="text-center">${newSecrets}</td>
                    <td class="text-center"><span class="text-success">${remediatedSecrets}</span></td>
                    <td class="text-center">${newSecrets - remediatedSecrets > 0 ? `+${newSecrets - remediatedSecrets}` : newSecrets - remediatedSecrets}</td>
                </tr>
                <tr class="table-active">
                    <td><strong>Total</strong></td>
                    <td class="text-center"><strong>${totalNew}</strong></td>
                    <td class="text-center"><strong><span class="text-success">${totalRemediated}</span></strong></td>
                    <td class="text-center"><strong>${totalNet > 0 ? `+${totalNet}` : totalNet}</strong></td>
                </tr>
            `;
        }

        function renderVerticalBreakdown() {
            const verticalStats = {};
            
            managerRepos.forEach(repo => {
                const verticals = repo._allVerticals && Array.isArray(repo._allVerticals) ? repo._allVerticals : (repo.vertical ? [repo.vertical] : []);
                verticals.forEach(vertical => {
                    if (!vertical || vertical === 'No Vertical Identified') return;
                    
                    if (!verticalStats[vertical]) {
                        verticalStats[vertical] = {
                            repos: new Set(),
                            sast: 0,
                            sca: 0,
                            secrets: 0,
                            critical: 0,
                            high: 0,
                            total: 0
                        };
                    }
                    
                    verticalStats[vertical].repos.add(repo.repository);
                    
                    const vulns = repo.vulnerabilities;
                    if (vulns) {
                        const codeScanning = vulns.codeScanning || {};
                        const dependabot = vulns.dependabot || {};
                        const secretScanning = vulns.secretScanning || {};
                        
                        verticalStats[vertical].sast += codeScanning.total || 0;
                        verticalStats[vertical].sca += dependabot.total || 0;
                        verticalStats[vertical].secrets += secretScanning.total || 0;
                        verticalStats[vertical].critical += (codeScanning.critical || 0) + (dependabot.critical || 0);
                        verticalStats[vertical].high += (codeScanning.high || 0) + (dependabot.high || 0);
                        verticalStats[vertical].total += (codeScanning.total || 0) + (dependabot.total || 0) + (secretScanning.total || 0);
                    }
                });
            });

            const tbody = document.getElementById('verticalBreakdownTable');
            const entries = Object.entries(verticalStats).sort((a, b) => b[1].total - a[1].total);

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No vertical data available</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map(([vertical, stats]) => `
                <tr>
                    <td><a href="vertical.html?name=${encodeURIComponent(vertical)}" class="text-decoration-none"><strong>${escapeHtml(vertical)}</strong></a></td>
                    <td class="text-center">${stats.repos.size}</td>
                    <td class="text-center">${stats.sast}</td>
                    <td class="text-center">${stats.sca}</td>
                    <td class="text-center">${stats.secrets}</td>
                    <td class="text-center">${stats.critical > 0 ? `<span class="badge bg-danger">${stats.critical}</span>` : '0'}</td>
                    <td class="text-center">${stats.high > 0 ? `<span class="badge bg-warning text-dark">${stats.high}</span>` : '0'}</td>
                    <td class="text-center"><strong>${stats.total}</strong></td>
                </tr>
            `).join('');
        }

        function renderPodBreakdown(managerPods) {
            const podStats = {};
            
            managerRepos.forEach(repo => {
                const repoPods = repo._allPods && Array.isArray(repo._allPods) ? repo._allPods : (repo.pod ? [repo.pod] : []);
                repoPods.forEach(pod => {
                    if (!managerPods.includes(pod)) return;
                    
                    if (!podStats[pod]) {
                        podStats[pod] = {
                            repos: new Set(),
                            vertical: pod.includes('-') ? pod.split('-').slice(0, -1).join('-') : 'Unknown',
                            sast: 0,
                            sca: 0,
                            secrets: 0,
                            critical: 0,
                            high: 0,
                            total: 0
                        };
                    }
                    
                    podStats[pod].repos.add(repo.repository);
                    
                    const vulns = repo.vulnerabilities;
                    if (vulns) {
                        const codeScanning = vulns.codeScanning || {};
                        const dependabot = vulns.dependabot || {};
                        const secretScanning = vulns.secretScanning || {};
                        
                        podStats[pod].sast += codeScanning.total || 0;
                        podStats[pod].sca += dependabot.total || 0;
                        podStats[pod].secrets += secretScanning.total || 0;
                        podStats[pod].critical += (codeScanning.critical || 0) + (dependabot.critical || 0);
                        podStats[pod].high += (codeScanning.high || 0) + (dependabot.high || 0);
                        podStats[pod].total += (codeScanning.total || 0) + (dependabot.total || 0) + (secretScanning.total || 0);
                    }
                });
            });

            const tbody = document.getElementById('podBreakdownTable');
            const entries = Object.entries(podStats).sort((a, b) => b[1].total - a[1].total);

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No pod data available</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map(([pod, stats]) => `
                <tr>
                    <td><a href="pod.html?name=${encodeURIComponent(pod)}" class="text-decoration-none"><strong>${escapeHtml(pod)}</strong></a></td>
                    <td class="text-center">${stats.vertical ? `<a href="vertical.html?name=${encodeURIComponent(stats.vertical)}" class="text-decoration-none">${escapeHtml(stats.vertical)}</a>` : '-'}</td>
                    <td class="text-center">${stats.repos.size}</td>
                    <td class="text-center">${stats.sast}</td>
                    <td class="text-center">${stats.sca}</td>
                    <td class="text-center">${stats.secrets}</td>
                    <td class="text-center">${stats.critical > 0 ? `<span class="badge bg-danger">${stats.critical}</span>` : '0'}</td>
                    <td class="text-center">${stats.high > 0 ? `<span class="badge bg-warning text-dark">${stats.high}</span>` : '0'}</td>
                    <td class="text-center"><strong>${stats.total}</strong></td>
                </tr>
            `).join('');
        }

        function renderRepositoriesTable() {
            const tbody = document.getElementById('repositoriesTable');
            tbody.innerHTML = managerRepos.map(repo => {
                const languageBadge = repo.language 
                    ? `<span class="badge bg-info badge-custom">${escapeHtml(repo.language)}</span>`
                    : '';

                const githubUrl = repo.githubUrl || `https://github.com/${repo.organization}/${repo.repository}`;
                
                const podsToShow = (repo._allPods && Array.isArray(repo._allPods) && repo._allPods.length > 0) 
                    ? repo._allPods 
                    : (repo.pod && repo.pod !== 'No Pod Selected' ? [repo.pod] : []);
                
                const podsHtml = podsToShow.length > 0
                    ? podsToShow.map(p => `<a href="pod.html?name=${encodeURIComponent(p)}" class="text-decoration-none"><span class="badge bg-primary badge-custom"><i class="cil-layers" aria-hidden="true"></i> ${escapeHtml(p)}</span></a>`).join(' ')
                    : '<span class="badge bg-secondary badge-custom" style="opacity: 0.7;">No Pod Selected</span>';

                const verticalsToShow = (repo._allVerticals && Array.isArray(repo._allVerticals) && repo._allVerticals.length > 0) 
                    ? repo._allVerticals 
                    : (repo.vertical && repo.vertical !== 'No Vertical Identified' ? [repo.vertical] : []);
                
                const verticalsHtml = verticalsToShow.length > 0
                    ? verticalsToShow.map(v => `<a href="vertical.html?name=${encodeURIComponent(v)}" class="text-decoration-none"><span class="badge bg-info badge-custom"><i class="cil-folder" aria-hidden="true"></i> ${escapeHtml(v)}</span></a>`).join(' ')
                    : '<span class="badge bg-secondary badge-custom" style="opacity: 0.7;">No Vertical Identified</span>';
                
                const securityHtml = renderSecurityCell(repo);
                
                return `
                    <tr>
                        <td>
                            <span class="badge badge-custom" style="background-color: #6366f1;">
                                <i class="cil-building"></i> ${escapeHtml(repo.organization)}
                            </span>
                        </td>
                        <td>
                            <a href="${githubUrl}" target="_blank" class="repo-link">
                                <i class="cil-code"></i> <strong>${escapeHtml(repo.repository)}</strong>
                            </a>
                            ${repo.description ? `<small class="text-muted d-block mt-1">${escapeHtml(repo.description)}</small>` : ''}
                        </td>
                        <td>${podsHtml}</td>
                        <td>${verticalsHtml}</td>
                        <td>${securityHtml}</td>
                        <td>${formatLastActivity(repo.lastActivity)}</td>
                        <td>${languageBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderSecurityCell(repo) {
            const vulns = repo.vulnerabilities;
            if (!vulns) {
                return `<span class="badge bg-success badge-custom" title="No security data available"><i class="cil-check-circle" aria-hidden="true"></i> Secure</span>`;
            }
            
            const codeScanning = vulns.codeScanning || {};
            const dependabot = vulns.dependabot || {};
            const secretScanning = vulns.secretScanning || {};
            
            const totalCritical = (codeScanning.critical || 0) + (dependabot.critical || 0);
            const totalHigh = (codeScanning.high || 0) + (dependabot.high || 0);
            const totalMedium = (codeScanning.medium || 0) + (dependabot.medium || 0);
            const totalSecrets = secretScanning.total || 0;
            const totalIssues = (codeScanning.total || 0) + (dependabot.total || 0) + totalSecrets;
            
            let tooltipParts = [];
            if ((codeScanning.total || 0) > 0) {
                tooltipParts.push(`SAST: ${codeScanning.total} (C:${codeScanning.critical || 0} H:${codeScanning.high || 0} M:${codeScanning.medium || 0} L:${codeScanning.low || 0} I:${codeScanning.info || 0})`);
            }
            if ((dependabot.total || 0) > 0) {
                tooltipParts.push(`SCA: ${dependabot.total} (C:${dependabot.critical || 0} H:${dependabot.high || 0} M:${dependabot.medium || 0} L:${dependabot.low || 0} I:${dependabot.info || 0})`);
            }
            if (totalSecrets > 0) {
                tooltipParts.push(`Secrets: ${totalSecrets}`);
            }
            const tooltip = tooltipParts.length > 0 ? tooltipParts.join(' | ') : 'No security issues';
            
            if (totalCritical > 0) {
                return `<span class="badge bg-danger badge-custom" title="${escapeHtml(tooltip)}" data-bs-toggle="tooltip" data-bs-placement="top"><i class="cil-warning" aria-hidden="true"></i> ${totalCritical} Critical</span>`;
            } else if (totalHigh > 0) {
                return `<span class="badge bg-warning badge-custom text-dark" title="${escapeHtml(tooltip)}" data-bs-toggle="tooltip" data-bs-placement="top"><i class="cil-warning" aria-hidden="true"></i> ${totalHigh} High</span>`;
            } else if (totalMedium > 0 || totalSecrets > 0) {
                return `<span class="badge bg-info badge-custom" title="${escapeHtml(tooltip)}" data-bs-toggle="tooltip" data-bs-placement="top"><i class="cil-info" aria-hidden="true"></i> ${totalMedium + totalSecrets}</span>`;
            } else if (totalIssues > 0) {
                return `<span class="badge bg-secondary badge-custom" title="${escapeHtml(tooltip)}" data-bs-toggle="tooltip" data-bs-placement="top">${totalIssues}</span>`;
            } else {
                return `<span class="badge bg-success badge-custom" title="No security issues"><i class="cil-check-circle" aria-hidden="true"></i> Secure</span>`;
            }
        }

        function formatLastActivity(dateString) {
            if (!dateString) return '<span class="text-muted" style="font-style: italic;">â</span>';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '<span class="text-muted" style="font-style: italic;">â</span>';
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch {
                return '<span class="text-muted" style="font-style: italic;">â</span>';
            }
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            document.getElementById('loadingSpinner').innerHTML = `
                <div class="alert alert-danger">
                    <i class="cil-warning"></i> ${escapeHtml(message)}
                </div>
            `;
        }

        function updateBreadcrumbs() {
            const breadcrumbNav = document.getElementById('breadcrumbNav');
            if (!breadcrumbNav || !managerName) return;

            const breadcrumb = breadcrumbNav.querySelector('.breadcrumb');
            breadcrumb.innerHTML = `
                <li class="breadcrumb-item"><a href="index.html"><i class="cil-home"></i> Home</a></li>
                <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
                <li class="breadcrumb-item active">${escapeHtml(managerName)}</li>
            `;
        }

        // Quick Lookup functionality
        let allPods = [];
        let allManagers = [];
        let allVerticals = [];

        function initializeQuickLookup() {
            const pods = new Set();
            const managers = new Set();
            const verticals = new Set();

            allRepos.forEach(repo => {
                if (repo._allPods) {
                    repo._allPods.forEach(p => pods.add(p));
                }
                if (repo._allManagers) {
                    repo._allManagers.forEach(m => managers.add(m));
                }
                if (repo._allVerticals) {
                    repo._allVerticals.forEach(v => verticals.add(v));
                }
            });

            Object.keys(podManagers).forEach(pod => pods.add(pod));
            Object.values(podManagers).forEach(manager => managers.add(manager));

            allPods = Array.from(pods).sort();
            allManagers = Array.from(managers).sort();
            allVerticals = Array.from(verticals).sort();
        }

        function showQuickLookupSuggestions(query) {
            const suggestions = document.getElementById('quickLookupSuggestions');
            
            if (!query || query.length < 2) {
                suggestions.classList.remove('show');
                return;
            }

            const q = query.toLowerCase();
            const matches = [];

            allPods.forEach(pod => {
                if (pod.toLowerCase().includes(q)) {
                    matches.push({ type: 'pod', name: pod, display: pod, icon: 'cil-layers' });
                }
            });

            allManagers.forEach(manager => {
                if (manager.toLowerCase().includes(q)) {
                    matches.push({ type: 'manager', name: manager, display: manager, icon: 'cil-user' });
                }
            });

            allVerticals.forEach(vertical => {
                if (vertical.toLowerCase().includes(q)) {
                    matches.push({ type: 'vertical', name: vertical, display: vertical, icon: 'cil-folder' });
                }
            });

            if (matches.length === 0) {
                suggestions.classList.remove('show');
                return;
            }

            suggestions.innerHTML = matches.slice(0, 10).map(match => `
                <div class="suggestion-item" data-type="${match.type}" data-name="${escapeHtml(match.name)}">
                    <i class="cil ${match.icon} suggestion-icon"></i>
                    <span>${escapeHtml(match.display)}</span>
                </div>
            `).join('');

            suggestions.classList.add('show');

            suggestions.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    const name = item.dataset.name;
                    if (type === 'pod') {
                        window.location.href = `pod.html?name=${encodeURIComponent(name)}`;
                    } else if (type === 'manager') {
                        window.location.href = `manager.html?name=${encodeURIComponent(name)}`;
                    } else if (type === 'vertical') {
                        window.location.href = `vertical.html?name=${encodeURIComponent(name)}`;
                    }
                });
            });
        }

        // Export functionality
        function exportData(format) {
            if (managerRepos.length === 0) {
                alert('No data to export');
                return;
            }

            if (format === 'csv') {
                exportCSV();
            } else {
                exportJSON();
            }
        }

        function exportCSV() {
            const headers = ['Organization', 'Repository', 'Pod', 'Vertical', 'Engineering Manager', 'Language', 'Description', 'Last Activity', 'Security Issues', 'SAST Total', 'SAST Critical', 'SAST High', 'SAST Medium', 'SAST Low', 'SAST Info', 'SCA Total', 'SCA Critical', 'SCA High', 'SCA Medium', 'SCA Low', 'SCA Info', 'Secrets Total', 'GitHub URL'];
            const rows = [headers.join(',')];

            managerRepos.forEach(repo => {
                const allPods = (repo._allPods && Array.isArray(repo._allPods) && repo._allPods.length > 0)
                    ? repo._allPods.join(', ')
                    : (repo.pod || '');
                const allVerticals = (repo._allVerticals && Array.isArray(repo._allVerticals) && repo._allVerticals.length > 0)
                    ? repo._allVerticals.join(', ')
                    : (repo.vertical || '');
                
                const vulns = repo.vulnerabilities;
                const codeScanning = vulns?.codeScanning || {};
                const dependabot = vulns?.dependabot || {};
                const secretScanning = vulns?.secretScanning || {};
                const totalIssues = (codeScanning.total || 0) + (dependabot.total || 0) + (secretScanning.total || 0);
                
                const row = [
                    repo.organization,
                    repo.repository,
                    allPods,
                    allVerticals,
                    managerName,
                    repo.language || '',
                    (repo.description || '').replace(/"/g, '""'),
                    repo.lastActivity || '',
                    totalIssues,
                    codeScanning.total || 0,
                    codeScanning.critical || 0,
                    codeScanning.high || 0,
                    codeScanning.medium || 0,
                    codeScanning.low || 0,
                    codeScanning.info || 0,
                    dependabot.total || 0,
                    dependabot.critical || 0,
                    dependabot.high || 0,
                    dependabot.medium || 0,
                    dependabot.low || 0,
                    dependabot.info || 0,
                    secretScanning.total || 0,
                    repo.githubUrl || `https://github.com/${repo.organization}/${repo.repository}`
                ].map(cell => `"${cell}"`);
                rows.push(row.join(','));
            });

            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `manager_${managerName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            const data = {
                exported: new Date().toISOString(),
                manager: managerName,
                count: managerRepos.length,
                repositories: managerRepos
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `manager_${managerName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Load verticals for sidebar navigation
        async function loadVerticalsForNav() {
            try {
                const response = await fetch('data/repositories.json');
                const data = await response.json();
                const normalized = normalizeRepositories(data.repositories || []);
                const verticals = [...new Set(normalized.map(r => r.vertical))]
                    .filter(v => v && v !== 'No Vertical Identified')
                    .sort();
                
                const navLinksContainer = document.getElementById('verticalNavLinks');
                if (navLinksContainer) {
                    navLinksContainer.innerHTML = verticals.map(vertical => {
                        const encodedVertical = encodeURIComponent(vertical);
                        return `
                            <li class="nav-item">
                                <a class="nav-link vertical-link" href="vertical.html?name=${encodedVertical}">
                                    <i class="nav-icon cil-folder"></i> ${escapeHtml(vertical)}
                                </a>
                            </li>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading verticals:', error);
            }
        }

        // Sidebar functionality
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            const sidebarToggle = document.getElementById('sidebarToggle');

            if (window.innerWidth > 768) {
                let isCollapsed = false;
                sidebar.addEventListener('click', (e) => {
                    if (e.target.closest('.nav-link')) {
                        if (window.innerWidth > 768) {
                            isCollapsed = !isCollapsed;
                            if (isCollapsed) {
                                sidebar.classList.remove('sidebar-expanded');
                                sidebar.classList.add('sidebar-minimized');
                                main.classList.add('sidebar-collapsed');
                            } else {
                                sidebar.classList.remove('sidebar-minimized');
                                sidebar.classList.add('sidebar-expanded');
                                main.classList.remove('sidebar-collapsed');
                            }
                        }
                    }
                });
            }

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('show');
                });
            }

            loadVerticalsForNav();
        }

        // Dark mode support
        const darkMode = localStorage.getItem('darkMode') === 'true';
        if (darkMode) {
            document.body.classList.add('dark-mode');
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.innerHTML = '<i class="cil-sun"></i>';
        }

        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', () => {
                const isDark = document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', isDark.toString());
                darkModeToggle.innerHTML = isDark ? '<i class="cil-sun"></i>' : '<i class="cil-moon"></i>';
            });
        }

        // Quick lookup event listeners
        const quickLookupInput = document.getElementById('quickLookupInput');
        if (quickLookupInput) {
            quickLookupInput.addEventListener('input', (e) => {
                showQuickLookupSuggestions(e.target.value);
            });

            quickLookupInput.addEventListener('blur', () => {
                setTimeout(() => {
                    document.getElementById('quickLookupSuggestions').classList.remove('show');
                }, 200);
            });

            quickLookupInput.addEventListener('focus', (e) => {
                if (e.target.value) {
                    showQuickLookupSuggestions(e.target.value);
                }
            });
        }

        // Initialize
        // Severity filter event listeners
        document.querySelectorAll('input[name="severityFilter"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentSeverityFilter = e.target.value;
                const managerPods = Object.keys(podManagers).filter(pod => podManagers[pod] === managerName);
                calculateManagerStats(managerPods);
            });
        });

        loadData().then(() => {
            initializeQuickLookup();
        });
        initSidebar();
    </script>
</body>
</html>

