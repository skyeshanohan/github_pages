<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Vertical Details - Repository Ownership Tracker</title>
    
    <!-- Preconnect to CDN for faster loading -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- CoreUI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@coreui/coreui@4.3.0/dist/css/coreui.min.css">
    <!-- CoreUI Icons -->
    <link rel="stylesheet" href="https://unpkg.com/@coreui/icons@2.1.0/css/all.min.css">
    
    <!-- Preload data file -->
    <link rel="preload" href="data/repositories.json" as="fetch" crossorigin>
    
    <style>
        :root {
            --cui-body-bg: #f5f7fa;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-sidebar: #495057;
            --text-sidebar-active: #321fdb;
            --border-color: #e9ecef;
            --hover-bg: #f8f9fa;
        }

        body.dark-mode {
            --cui-body-bg: #0d1117;
            --bg-primary: #161b22;
            --bg-secondary: #21262d;
            --bg-sidebar: #161b22;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-sidebar: #c9d1d9;
            --text-sidebar-active: #58a6ff;
            --border-color: #30363d;
            --hover-bg: #21262d;
            background-color: var(--cui-body-bg);
            color: var(--text-primary);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--cui-body-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .dark-mode .card,
        .dark-mode .navbar {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            background: linear-gradient(180deg, var(--bg-sidebar) 0%, var(--bg-secondary) 100%);
            transition: background-color 0.3s, color 0.3s;
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .dark-mode .sidebar {
            background: linear-gradient(180deg, var(--bg-sidebar) 0%, #1a1e24 100%);
            box-shadow: 2px 0 8px rgba(0,0,0,0.3);
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-sidebar);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .sidebar-brand:hover {
            color: var(--text-sidebar-active);
        }

        .sidebar-brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #321fdb 0%, #6366f1 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
        }

        .sidebar-section-title {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .sidebar .nav-link {
            color: var(--text-sidebar) !important;
            transition: all 0.2s;
            padding: 0.75rem 1rem !important;
            margin: 0.125rem 0.5rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        .sidebar .nav-link:hover {
            background-color: var(--hover-bg);
            color: var(--text-sidebar-active) !important;
            transform: translateX(2px);
        }

        .sidebar .nav-link.active {
            background: linear-gradient(90deg, rgba(50, 31, 219, 0.1) 0%, transparent 100%);
            color: var(--text-sidebar-active) !important;
            border-left: 3px solid var(--text-sidebar-active);
            font-weight: 500;
        }

        .dark-mode .sidebar .nav-link.active {
            background: linear-gradient(90deg, rgba(88, 166, 255, 0.15) 0%, transparent 100%);
        }

        .sidebar .nav-icon {
            color: inherit;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-sidebar);
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .vertical-link {
            padding-left: 2rem !important;
            font-size: 0.9rem;
        }

        .vertical-link .nav-icon {
            font-size: 0.9rem;
        }

        .nav-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.5rem 1rem;
        }
        
        .sidebar-minimized {
            width: 56px;
        }

        .sidebar-expanded {
            width: 256px;
        }

        .main {
            margin-left: 256px;
            transition: margin-left 0.25s;
        }

        .main.sidebar-collapsed {
            margin-left: 56px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.25s;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main {
                margin-left: 0;
            }
        }

        .navbar {
            background-color: var(--bg-primary) !important;
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand,
        .navbar-text {
            color: var(--text-primary) !important;
        }

        .stats-card {
            border-left: 4px solid #321fdb;
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: var(--bg-primary);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .stats-card .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .dark-mode .stats-card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
        }

        .dark-mode .stats-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border-left-color: #58a6ff;
        }

        .info-card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
        }

        .info-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .badge-custom {
            padding: 0.35em 0.65em;
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
        }

        .repo-link {
            color: inherit;
            text-decoration: none;
        }

        .repo-link:hover {
            color: #321fdb;
            text-decoration: underline;
        }

        .dark-mode .repo-link:hover {
            color: #58a6ff;
        }

        .breadcrumb-container {
            background: var(--bg-secondary);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .breadcrumb {
            margin-bottom: 0;
            background: transparent;
            padding: 0;
        }

        .breadcrumb-item a {
            color: var(--text-sidebar-active);
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .breadcrumb-item a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .breadcrumb-item.active {
            color: var(--text-primary);
        }

        /* Quick Lookup Bar */
        .quick-lookup-container {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }

        .quick-lookup-wrapper {
            max-width: 600px;
            position: relative;
        }

        .quick-lookup-input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .quick-lookup-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .quick-lookup-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }

        .dark-mode .quick-lookup-suggestions {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .quick-lookup-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: var(--hover-bg);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-icon {
            color: var(--text-sidebar-active);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-width: 400px;
        }

        .toast {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
        }

        .dark-mode .toast {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .toast-success {
            border-left: 4px solid #2eb85c;
        }

        .toast-error {
            border-left: 4px solid #e55353;
        }

        .toast-info {
            border-left: 4px solid #321fdb;
        }

        .toast-warning {
            border-left: 4px solid #f9b115;
        }

        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast-success .toast-icon {
            color: #2eb85c;
        }

        .toast-error .toast-icon {
            color: #e55353;
        }

        .toast-info .toast-icon {
            color: #321fdb;
        }

        .toast-warning .toast-icon {
            color: #f9b115;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .toast-close {
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .toast-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast.fade-out {
            animation: slideOutRight 0.3s ease-in forwards;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar sidebar-expanded" id="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="sidebar-brand">
                <div class="sidebar-brand-icon">
                    <i class="cil-code"></i>
                </div>
                <span>Repo Tracker</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <ul class="nav">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html">
                        <i class="nav-icon cil-speedometer"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="nav-icon cil-list"></i> Repository Table
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="stats.html">
                        <i class="nav-icon cil-chart"></i> Statistics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="health.html">
                        <i class="nav-icon cil-heart"></i> Health
                    </a>
                </li>
                <div class="nav-divider"></div>
                <li class="sidebar-section">
                    <div class="sidebar-section-title">Verticals</div>
                    <ul class="nav" id="verticalNavLinks"></ul>
                </li>
                <div class="nav-divider"></div>
                <li class="nav-item">
                    <a class="nav-link" href="about.html">
                        <i class="nav-icon cil-info"></i> About
                    </a>
                </li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <div>© 2024</div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main" id="main">
        <!-- Header -->
        <header class="navbar navbar-expand navbar-light bg-white border-bottom">
            <div class="container-fluid">
                <button class="btn btn-link d-md-none" id="sidebarToggle">
                    <i class="cil-menu"></i>
                </button>
                <h4 class="navbar-brand mb-0" id="pageTitle">Vertical Details</h4>
                <div class="navbar-nav ms-auto">
                    <button class="btn btn-sm btn-outline-secondary me-2" id="darkModeToggle" title="Toggle dark mode">
                        <i class="cil-moon"></i>
                    </button>
                    <span class="navbar-text">
                        <i class="cil-github"></i> GitHub Pages
                    </span>
                </div>
            </div>
        </header>

        <!-- Quick Lookup Bar -->
        <div class="quick-lookup-container">
            <div class="container-fluid">
                <div class="quick-lookup-wrapper">
                    <i class="cil-magnifying-glass quick-lookup-icon"></i>
                    <input type="text" class="quick-lookup-input" id="quickLookupInput" placeholder="Search pods, managers, or verticals... (e.g., 'Vertical1-Pod1' or 'Sarah Johnson')" autocomplete="off">
                    <div class="quick-lookup-suggestions" id="quickLookupSuggestions"></div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="body flex-grow-1 p-3">
            <!-- Breadcrumbs -->
            <nav aria-label="breadcrumb" class="breadcrumb-container" id="breadcrumbNav">
                <ol class="breadcrumb mb-0">
                </ol>
            </nav>

            <div class="loading-spinner" id="loadingSpinner" style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div id="content" class="d-none">
                <!-- Vertical Header -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div>
                                <h2 class="mb-1" id="verticalName">-</h2>
                                <p class="text-muted mb-0" id="verticalDescription">Repository ownership information for this vertical</p>
                            </div>
                            <div class="text-end">
                                <div class="fs-3 fw-bold" id="totalReposCount">-</div>
                                <div class="text-muted small">Repositories</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="row mb-4 g-3 justify-content-center">
                    <div class="col-sm-6 col-lg-3 d-flex">
                        <div class="card mb-4 stats-card w-100">
                            <div class="card-body">
                                <div class="fs-4 fw-semibold" id="orgsCount">-</div>
                                <div class="text-medium-emphasis text-uppercase fw-semibold small">Organizations</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3 d-flex">
                        <div class="card mb-4 stats-card w-100" style="border-left-color: #e55353;">
                            <div class="card-body">
                                <div class="fs-4 fw-semibold" id="podsCount">-</div>
                                <div class="text-medium-emphasis text-uppercase fw-semibold small">Pods</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3 d-flex">
                        <div class="card mb-4 stats-card w-100" style="border-left-color: #f9b115;">
                            <div class="card-body">
                                <div class="fs-4 fw-semibold" id="managersCount">-</div>
                                <div class="text-medium-emphasis text-uppercase fw-semibold small">Engineering Managers</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Overview Dashboard -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <strong><i class="cil-shield-alt"></i> Security Overview</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-4 justify-content-center">
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #e55353;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="totalSecurityIssues">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">Total Issues</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #e55353;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="criticalVulns">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">Critical</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #f9b115;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="highVulns">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">High</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #39afd1;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="sastAlerts">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">SAST</div>
                                        <div class="text-muted small">Static Analysis</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #f9b115;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="scaAlerts">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">SCA</div>
                                        <div class="text-muted small">Dependency Scan</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4 col-lg-2 d-flex">
                                <div class="card stats-card w-100" style="border-left-color: #8750de;">
                                    <div class="card-body">
                                        <div class="fs-4 fw-semibold" id="exposedSecrets">0</div>
                                        <div class="text-medium-emphasis text-uppercase fw-semibold small">Secrets</div>
                                        <div class="text-muted small">Secret Scanning</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shared Ownership Alert -->
                <div class="alert alert-info d-none" id="sharedOwnershipAlert" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="cil-info me-2" style="font-size: 1.25rem;"></i>
                        <div>
                            <strong><span id="sharedOwnershipCount">0</span> repositories</strong> have multiple owners (shared across pods/managers). These repositories are counted in multiple statistics below.
                        </div>
                    </div>
                </div>

                <!-- Vulnerability Breakdown by Pod -->
                <div class="card mb-4">
                    <div class="card-header">
                        <strong><i class="cil-shield-alt"></i> Security Issues by Pod</strong>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Pod</th>
                                        <th rowspan="2" class="text-center align-middle">Repos</th>
                                        <th colspan="5" class="text-center border-bottom">Severity Levels</th>
                                        <th colspan="3" class="text-center border-bottom">Security Type</th>
                                        <th rowspan="2" class="text-center align-middle">Total</th>
                                    </tr>
                                    <tr>
                                        <th class="text-center">Critical</th>
                                        <th class="text-center">High</th>
                                        <th class="text-center">Medium</th>
                                        <th class="text-center">Low</th>
                                        <th class="text-center">Info</th>
                                        <th class="text-center">SAST</th>
                                        <th class="text-center">SCA</th>
                                        <th class="text-center">Secrets</th>
                                    </tr>
                                </thead>
                                <tbody id="podSecurityTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vulnerability Breakdown by Engineering Manager -->
                <div class="card mb-4">
                    <div class="card-header">
                        <strong><i class="cil-shield-alt"></i> Security Issues by Engineering Manager</strong>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Engineering Manager</th>
                                        <th rowspan="2" class="text-center align-middle">Repos</th>
                                        <th colspan="5" class="text-center border-bottom">Severity Levels</th>
                                        <th colspan="3" class="text-center border-bottom">Security Type</th>
                                        <th rowspan="2" class="text-center align-middle">Total</th>
                                    </tr>
                                    <tr>
                                        <th class="text-center">Critical</th>
                                        <th class="text-center">High</th>
                                        <th class="text-center">Medium</th>
                                        <th class="text-center">Low</th>
                                        <th class="text-center">Info</th>
                                        <th class="text-center">SAST</th>
                                        <th class="text-center">SCA</th>
                                        <th class="text-center">Secrets</th>
                                    </tr>
                                </thead>
                                <tbody id="managerSecurityTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Organizations -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <strong><i class="cil-building"></i> Organizations</strong>
                            </div>
                            <div class="card-body" id="organizationsList">
                            </div>
                        </div>
                    </div>

                    <!-- Pods -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <strong><i class="cil-layers"></i> Pods</strong>
                            </div>
                            <div class="card-body" id="podsList">
                            </div>
                        </div>
                    </div>

                    <!-- Engineering Managers -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <strong><i class="cil-people"></i> Engineering Managers</strong>
                            </div>
                            <div class="card-body" id="managersList">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repositories Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Repositories</strong>
                        <div class="d-flex align-items-center gap-2">
                            <span id="repoCount" class="badge bg-secondary"></span>
                            <button class="btn btn-sm btn-primary" id="exportBtn" onclick="exportData('csv')">
                                <i class="cil-save"></i> Export CSV
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportData('json')">
                                <i class="cil-save"></i> Export JSON
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Organization</th>
                                        <th>Repository</th>
                                        <th>Pod</th>
                                        <th>Engineering Manager</th>
                                        <th>Security</th>
                                        <th>Last Activity</th>
                                        <th>Language</th>
                                    </tr>
                                </thead>
                                <tbody id="repositoriesTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CoreUI JS -->
    <script src="https://unpkg.com/@coreui/coreui@4.3.0/dist/js/coreui.bundle.min.js" defer></script>
    
    <script>
        let allRepos = [];
        let verticalName = '';
        let verticalRepos = [];
        let podManagers = {};

        // Get vertical name from URL
        function getVerticalFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('name') || '';
        }

        // Normalize repositories (same logic as main app)
        function normalizeRepositories(repos) {
            // Filter out archived repositories - only process active repositories
            return (repos || []).filter(repo => repo.status !== 'archived').map(repo => {
                const normalized = { ...repo };
                let podArray = [];
                if (Array.isArray(normalized.pod)) {
                    podArray = normalized.pod.filter(p => p && p.trim() && p !== 'No Pod Selected');
                } else if (typeof normalized.pod === 'string') {
                    podArray = normalized.pod.split(',').map(p => p.trim()).filter(p => p && p !== 'No Pod Selected');
                }
                // Set primary pod (first meaningful one)
                normalized.pod = podArray.length > 0 ? podArray[0] : 'No Pod Selected';
                
                // Store all pods for filtering
                normalized._allPods = podArray;
                
                // Derive all verticals from all pods
                const allVerticals = new Set();
                podArray.forEach(pod => {
                    if (pod && pod.includes('-')) {
                        const parts = pod.split('-');
                        const vertical = parts.slice(0, -1).join('-');
                        if (vertical) allVerticals.add(vertical);
                    }
                });
                
                // Also add explicitly set vertical if it exists
                if (normalized.vertical && normalized.vertical.trim() && normalized.vertical !== 'No Vertical Identified') {
                    allVerticals.add(normalized.vertical);
                }
                
                // Store all verticals
                normalized._allVerticals = Array.from(allVerticals);
                
                // Derive primary vertical when empty
                if (!normalized.vertical || !normalized.vertical.trim()) {
                    if (allVerticals.size > 0) {
                        normalized.vertical = Array.from(allVerticals)[0];
                    } else if (normalized.pod && normalized.pod.includes('-') && normalized.pod !== 'No Pod Selected') {
                        const parts = normalized.pod.split('-');
                        normalized.vertical = parts.slice(0, -1).join('-') || '';
                    } else {
                        normalized.vertical = 'No Vertical Identified';
                    }
                }
                // Collect all engineering managers from all pods
                const allManagers = new Set();
                if (podManagers && Object.keys(podManagers).length > 0) {
                    podArray.forEach(pod => {
                        if (pod && podManagers[pod]) {
                            allManagers.add(podManagers[pod]);
                        }
                    });
                }
                // Also add existing engineering manager if set
                if (normalized.engineeringManager && normalized.engineeringManager.trim()) {
                    allManagers.add(normalized.engineeringManager.trim());
                }
                // Store all managers
                normalized._allManagers = Array.from(allManagers);
                // Set primary manager (first one, or existing)
                if (normalized.engineeringManager && normalized.engineeringManager.trim()) {
                    // Keep existing if set
                } else if (allManagers.size > 0) {
                    normalized.engineeringManager = Array.from(allManagers)[0];
                }
                if (!normalized.status) normalized.status = 'active';
                return normalized;
            });
        }

        // Load Pod -> Engineering Manager mapping
        async function loadPodManagers() {
            try {
                const res = await fetch('data/pod-managers.yaml');
                if (!res.ok) return;
                const yaml = await res.text();
                podManagers = parseSimpleYamlMap(yaml);
            } catch {}
        }

        function parseSimpleYamlMap(text) {
            const map = {};
            if (!text) return map;
            const lines = text.split(/\r?\n/);
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) continue;
                const idx = trimmed.indexOf(':');
                if (idx === -1) continue;
                const key = trimmed.slice(0, idx).trim();
                let value = trimmed.slice(idx + 1).trim();
                if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
                    value = value.slice(1, -1);
                }
                if (key) map[key] = value;
            }
            return map;
        }

        // Load data
        async function loadData() {
            try {
                await loadPodManagers();
                const response = await fetch('data/repositories.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                allRepos = normalizeRepositories(data.repositories || []);
                
                verticalName = decodeURIComponent(getVerticalFromURL());
                if (!verticalName) {
                    showError('No vertical specified');
                    return;
                }

                // Filter repositories by vertical (include repos mapped to this vertical via any pod)
                verticalRepos = allRepos.filter(repo => {
                    // Check primary vertical
                    if (repo.vertical === verticalName) return true;
                    // Check all verticals from _allVerticals array
                    if (repo._allVerticals && Array.isArray(repo._allVerticals)) {
                        if (repo._allVerticals.includes(verticalName)) return true;
                    }
                    // Also check _allPods directly
                    if (repo._allPods && Array.isArray(repo._allPods)) {
                        if (repo._allPods.some(pod => {
                            if (pod && pod.includes('-')) {
                                const derivedVertical = pod.split('-').slice(0, -1).join('-');
                                return derivedVertical === verticalName;
                            }
                            return false;
                        })) return true;
                    }
                    // Fallback: derive from pods if _allVerticals not set
                    const podList = Array.isArray(repo.pod) ? repo.pod : (repo.pod ? [repo.pod] : []);
                    return podList.some(p => p && p.includes('-') && p.split('-').slice(0, -1).join('-') === verticalName);
                });
                
                console.log(`Filtering for vertical: "${verticalName}"`, {
                    totalRepos: allRepos.length,
                    filteredRepos: verticalRepos.length,
                    sampleRepos: allRepos.slice(0, 3).map(r => ({
                        repo: r.repository,
                        vertical: r.vertical,
                        _allVerticals: r._allVerticals,
                        _allPods: r._allPods,
                        pod: r.pod
                    }))
                });
                
                if (verticalRepos.length === 0) {
                    showError(`No repositories found for vertical: ${escapeHtml(verticalName)}`);
                    return;
                }

                renderVerticalDetails();
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error loading data. Please ensure data/repositories.json exists.');
            }
        }

        function renderVerticalDetails() {
            document.getElementById('loadingSpinner').classList.add('d-none');
            document.getElementById('content').classList.remove('d-none');

            // Update title
            document.getElementById('pageTitle').textContent = verticalName;
            document.getElementById('verticalName').textContent = verticalName;
            document.getElementById('totalReposCount').textContent = verticalRepos.length;

            // Update breadcrumbs
            updateBreadcrumbs();

            // Calculate statistics
            const orgs = new Set();
            const pods = new Set();

            verticalRepos.forEach(repo => {
                orgs.add(repo.organization);
                // Count all pods from this vertical (from _allPods)
                const allPods = repo._allPods && Array.isArray(repo._allPods) ? repo._allPods : (repo.pod ? [repo.pod] : []);
                allPods.forEach(pod => {
                    if (pod && pod.includes('-')) {
                        const derivedVertical = pod.split('-').slice(0, -1).join('-');
                        if (derivedVertical === verticalName) {
                            pods.add(pod);
                        }
                    }
                });
            });

            // Count managers correctly - only those assigned to pods in this vertical
            const managers = new Set();
            if (podManagers && Object.keys(podManagers).length > 0) {
                pods.forEach(pod => {
                    const assignedManager = podManagers[pod];
                    if (assignedManager && assignedManager.trim()) {
                        managers.add(assignedManager.trim());
                    }
                });
            }

            document.getElementById('orgsCount').textContent = orgs.size;
            document.getElementById('podsCount').textContent = pods.size;
            document.getElementById('managersCount').textContent = managers.size;
            document.getElementById('repoCount').textContent = `${verticalRepos.length} ${verticalRepos.length === 1 ? 'repository' : 'repositories'}`;

            // Calculate and render security statistics
            calculateSecurityStats();

            // Render organizations
            const orgCounts = {};
            verticalRepos.forEach(repo => {
                orgCounts[repo.organization] = (orgCounts[repo.organization] || 0) + 1;
            });
            renderList('organizationsList', orgCounts, 'organization');

            // Render pods
            const podCounts = {};
            verticalRepos.forEach(repo => {
                // Count pods from _allPods that belong to this vertical
                const allPods = repo._allPods && Array.isArray(repo._allPods) ? repo._allPods : (repo.pod ? [repo.pod] : []);
                allPods.forEach(pod => {
                    if (pod && pod.includes('-')) {
                        const derivedVertical = pod.split('-').slice(0, -1).join('-');
                        if (derivedVertical === verticalName) {
                            podCounts[pod] = (podCounts[pod] || 0) + 1;
                        }
                    }
                });
            });
            renderList('podsList', podCounts, 'pod');

            // Render managers - only count managers who are assigned to pods in this vertical
            const managerCounts = {};
            const verticalPods = new Set(pods);
            
            // Find which managers are assigned to pods in this vertical
            const verticalManagers = new Set();
            if (podManagers && Object.keys(podManagers).length > 0) {
                Object.entries(podManagers).forEach(([pod, assignedManager]) => {
                    if (verticalPods.has(pod) && assignedManager && assignedManager.trim()) {
                        verticalManagers.add(assignedManager.trim());
                    }
                });
            }
            
            // Count repositories per manager (only for this vertical's pods)
            verticalRepos.forEach(repo => {
                const repoPods = repo._allPods && Array.isArray(repo._allPods) ? repo._allPods : (repo.pod ? [repo.pod] : []);
                repoPods.forEach(repoPod => {
                    if (verticalPods.has(repoPod) && podManagers && podManagers[repoPod]) {
                        const manager = podManagers[repoPod].trim();
                        if (manager) {
                            managerCounts[manager] = (managerCounts[manager] || 0) + 1;
                        }
                    }
                });
            });
            renderList('managersList', managerCounts, 'manager');

            // Render repositories table
            renderRepositoriesTable();
        }

        function renderSecurityCell(repo) {
            const vulns = repo.vulnerabilities;
            if (!vulns) {
                return `<span class="badge bg-success badge-custom" title="No security data available"><i class="cil-check-circle" aria-hidden="true"></i> Secure</span>`;
            }
            
            const codeScanning = vulns.codeScanning || {};
            const dependabot = vulns.dependabot || {};
            const secretScanning = vulns.secretScanning || {};
            
            const totalCritical = (codeScanning.critical || 0) + (dependabot.critical || 0);
            const totalHigh = (codeScanning.high || 0) + (dependabot.high || 0);
            const totalMedium = (codeScanning.medium || 0) + (dependabot.medium || 0);
            const totalSecrets = secretScanning.total || 0;
            const totalIssues = (codeScanning.total || 0) + (dependabot.total || 0) + totalSecrets;
            
            // Build tooltip with all severity levels
            let tooltipParts = [];
            if ((codeScanning.total || 0) > 0) {
                tooltipParts.push(`SAST: ${codeScanning.total} (C:${codeScanning.critical || 0} H:${codeScanning.high || 0} M:${codeScanning.medium || 0} L:${codeScanning.low || 0} I:${codeScanning.info || 0})`);
            }
            if ((dependabot.total || 0) > 0) {
                tooltipParts.push(`SCA: ${dependabot.total} (C:${dependabot.critical || 0} H:${dependabot.high || 0} M:${dependabot.medium || 0} L:${dependabot.low || 0} I:${dependabot.info || 0})`);
            }
            if (totalSecrets > 0) {
                tooltipParts.push(`Secrets: ${totalSecrets}`);
            }
            const tooltip = tooltipParts.length > 0 ? tooltipParts.join(' | ') : 'No security issues';
            
            // Color code by severity
            if (totalCritical > 0) {
                return `<span class="badge bg-danger badge-custom" title="${escapeHtml(tooltip)}" data-bs-toggle="tooltip" data-bs-placement="top"><i class="cil-warning" aria-hidden="true"></i> ${totalCritical} Critical</span>`;
            } else if (totalHigh > 0) {
                return `<span class="badge bg-warning badge-custom text-dark" title="${escapeHtml(tooltip)}" data-bs-toggle="tooltip" data-bs-placement="top"><i class="cil-warning" aria-hidden="true"></i> ${totalHigh} High</span>`;
            } else if (totalMedium > 0 || totalSecrets > 0) {
                return `<span class="badge bg-info badge-custom" title="${escapeHtml(tooltip)}" data-bs-toggle="tooltip" data-bs-placement="top"><i class="cil-info" aria-hidden="true"></i> ${totalMedium + totalSecrets}</span>`;
            } else if (totalIssues > 0) {
                return `<span class="badge bg-secondary badge-custom" title="${escapeHtml(tooltip)}" data-bs-toggle="tooltip" data-bs-placement="top">${totalIssues}</span>`;
            } else {
                return `<span class="badge bg-success badge-custom" title="No security issues"><i class="cil-check-circle" aria-hidden="true"></i> Secure</span>`;
            }
        }

        function calculateSecurityStats() {
            let totalSecurityIssues = 0;
            let totalCritical = 0;
            let totalHigh = 0;
            let totalMedium = 0;
            let totalLow = 0;
            let totalInfo = 0;
            let totalSAST = 0;
            let totalSCA = 0;
            let totalSecrets = 0;
            let sharedOwnershipCount = 0;

            // Track security by pod
            const podSecurity = {};
            // Track security by manager
            const managerSecurity = {};

            verticalRepos.forEach(repo => {
                // Check for shared ownership
                const podsToShow = (repo._allPods && Array.isArray(repo._allPods) && repo._allPods.length > 0) 
                    ? repo._allPods 
                    : (repo.pod && repo.pod !== 'No Pod Selected' ? [repo.pod] : []);
                const managersToShow = (repo._allManagers && Array.isArray(repo._allManagers) && repo._allManagers.length > 0)
                    ? repo._allManagers
                    : (repo.engineeringManager && repo.engineeringManager.trim() ? [repo.engineeringManager.trim()] : []);
                
                if (podsToShow.length > 1 || managersToShow.length > 1) {
                    sharedOwnershipCount++;
                }

                const vulns = repo.vulnerabilities;
                if (!vulns) return;

                const codeScanning = vulns.codeScanning || {};
                const dependabot = vulns.dependabot || {};
                const secretScanning = vulns.secretScanning || {};
                
                // Aggregate all severity levels
                const repoCritical = (codeScanning.critical || 0) + (dependabot.critical || 0);
                const repoHigh = (codeScanning.high || 0) + (dependabot.high || 0);
                const repoMedium = (codeScanning.medium || 0) + (dependabot.medium || 0);
                const repoLow = (codeScanning.low || 0) + (dependabot.low || 0);
                const repoInfo = (codeScanning.info || 0) + (dependabot.info || 0);
                const repoSAST = codeScanning.total || 0;
                const repoSCA = dependabot.total || 0;
                const repoSecrets = secretScanning.total || 0;
                const repoIssues = repoSAST + repoSCA + repoSecrets;

                totalSecurityIssues += repoIssues;
                totalCritical += repoCritical;
                totalHigh += repoHigh;
                totalMedium += repoMedium;
                totalLow += repoLow;
                totalInfo += repoInfo;
                totalSAST += repoSAST;
                totalSCA += repoSCA;
                totalSecrets += repoSecrets;

                // Count vulnerabilities for each pod this repo belongs to (within this vertical)
                podsToShow.forEach(pod => {
                    if (pod && pod.includes('-')) {
                        const derivedVertical = pod.split('-').slice(0, -1).join('-');
                        if (derivedVertical === verticalName) {
                            if (!podSecurity[pod]) {
                                podSecurity[pod] = {
                                    repos: new Set(),
                                    critical: 0,
                                    high: 0,
                                    medium: 0,
                                    low: 0,
                                    info: 0,
                                    sast: 0,
                                    sca: 0,
                                    secrets: 0,
                                    total: 0
                                };
                            }
                            podSecurity[pod].repos.add(repo.repository);
                            podSecurity[pod].critical += repoCritical;
                            podSecurity[pod].high += repoHigh;
                            podSecurity[pod].medium += repoMedium;
                            podSecurity[pod].low += repoLow;
                            podSecurity[pod].info += repoInfo;
                            podSecurity[pod].sast += repoSAST;
                            podSecurity[pod].sca += repoSCA;
                            podSecurity[pod].secrets += repoSecrets;
                            podSecurity[pod].total += repoIssues;
                        }
                    }
                });

                // Count vulnerabilities for each manager - but only for pods they're assigned to in this vertical
                // Only iterate through pods in this vertical and find their assigned managers
                podsToShow.forEach(repoPod => {
                    if (repoPod && repoPod.includes('-')) {
                        const derivedVertical = repoPod.split('-').slice(0, -1).join('-');
                        if (derivedVertical === verticalName) {
                            // Find the manager assigned to this pod
                            const assignedManager = podManagers && podManagers[repoPod] ? podManagers[repoPod].trim() : null;
                            if (assignedManager) {
                                const managerKey = assignedManager;
                                if (!managerSecurity[managerKey]) {
                                    managerSecurity[managerKey] = {
                                        repos: new Set(),
                                        critical: 0,
                                        high: 0,
                                        medium: 0,
                                        low: 0,
                                        info: 0,
                                        sast: 0,
                                        sca: 0,
                                        secrets: 0,
                                        total: 0
                                    };
                                }
                                managerSecurity[managerKey].repos.add(repo.repository);
                                managerSecurity[managerKey].critical += repoCritical;
                                managerSecurity[managerKey].high += repoHigh;
                                managerSecurity[managerKey].medium += repoMedium;
                                managerSecurity[managerKey].low += repoLow;
                                managerSecurity[managerKey].info += repoInfo;
                                managerSecurity[managerKey].sast += repoSAST;
                                managerSecurity[managerKey].sca += repoSCA;
                                managerSecurity[managerKey].secrets += repoSecrets;
                                managerSecurity[managerKey].total += repoIssues;
                            }
                        }
                    }
                });
            });

            // Update overview cards
            document.getElementById('totalSecurityIssues').textContent = totalSecurityIssues;
            document.getElementById('criticalVulns').textContent = totalCritical;
            document.getElementById('highVulns').textContent = totalHigh;
            document.getElementById('sastAlerts').textContent = totalSAST;
            document.getElementById('scaAlerts').textContent = totalSCA;
            document.getElementById('exposedSecrets').textContent = totalSecrets;

            // Show shared ownership alert
            if (sharedOwnershipCount > 0) {
                document.getElementById('sharedOwnershipCount').textContent = sharedOwnershipCount;
                document.getElementById('sharedOwnershipAlert').classList.remove('d-none');
            } else {
                document.getElementById('sharedOwnershipAlert').classList.add('d-none');
            }

            // Render pod security table
            renderPodSecurityTable(podSecurity);

            // Render manager security table
            renderManagerSecurityTable(managerSecurity);
        }

        function renderPodSecurityTable(podSecurity) {
            const tbody = document.getElementById('podSecurityTable');
            const entries = Object.entries(podSecurity)
                .sort((a, b) => {
                    // Sort by total issues (desc), then critical (desc), then high (desc)
                    if (b[1].total !== a[1].total) return b[1].total - a[1].total;
                    if (b[1].critical !== a[1].critical) return b[1].critical - a[1].critical;
                    return b[1].high - a[1].high;
                });

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">No pod data available</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map(([pod, stats]) => {
                const repoCount = stats.repos.size;
                const criticalBadge = stats.critical > 0 
                    ? `<span class="badge bg-danger">${stats.critical}</span>`
                    : '<span class="text-muted">0</span>';
                const highBadge = stats.high > 0
                    ? `<span class="badge bg-warning text-dark">${stats.high}</span>`
                    : '<span class="text-muted">0</span>';
                const mediumBadge = stats.medium > 0
                    ? `<span class="badge bg-info">${stats.medium}</span>`
                    : '<span class="text-muted">0</span>';
                const lowBadge = stats.low > 0
                    ? `<span class="badge bg-secondary">${stats.low}</span>`
                    : '<span class="text-muted">0</span>';
                const infoBadge = stats.info > 0
                    ? `<span class="badge bg-light text-dark">${stats.info}</span>`
                    : '<span class="text-muted">0</span>';
                const sastBadge = stats.sast > 0
                    ? `<span class="badge" style="background-color: #39afd1; color: white;">${stats.sast}</span>`
                    : '<span class="text-muted">0</span>';
                const scaBadge = stats.sca > 0
                    ? `<span class="badge bg-warning text-dark">${stats.sca}</span>`
                    : '<span class="text-muted">0</span>';
                const secretsBadge = stats.secrets > 0
                    ? `<span class="badge" style="background-color: #8750de; color: white;">${stats.secrets}</span>`
                    : '<span class="text-muted">0</span>';
                const totalBadge = stats.total > 0
                    ? `<span class="badge bg-secondary">${stats.total}</span>`
                    : '<span class="text-success">0</span>';

                return `
                    <tr>
                        <td><strong>${escapeHtml(pod)}</strong></td>
                        <td class="text-center">${repoCount}</td>
                        <td class="text-center">${criticalBadge}</td>
                        <td class="text-center">${highBadge}</td>
                        <td class="text-center">${mediumBadge}</td>
                        <td class="text-center">${lowBadge}</td>
                        <td class="text-center">${infoBadge}</td>
                        <td class="text-center">${sastBadge}</td>
                        <td class="text-center">${scaBadge}</td>
                        <td class="text-center">${secretsBadge}</td>
                        <td class="text-center">${totalBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderManagerSecurityTable(managerSecurity) {
            const tbody = document.getElementById('managerSecurityTable');
            const entries = Object.entries(managerSecurity)
                .sort((a, b) => {
                    // Sort by total issues (desc), then critical (desc), then high (desc)
                    if (b[1].total !== a[1].total) return b[1].total - a[1].total;
                    if (b[1].critical !== a[1].critical) return b[1].critical - a[1].critical;
                    return b[1].high - a[1].high;
                });

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">No engineering manager data available</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map(([manager, stats]) => {
                const repoCount = stats.repos.size;
                const criticalBadge = stats.critical > 0 
                    ? `<span class="badge bg-danger">${stats.critical}</span>`
                    : '<span class="text-muted">0</span>';
                const highBadge = stats.high > 0
                    ? `<span class="badge bg-warning text-dark">${stats.high}</span>`
                    : '<span class="text-muted">0</span>';
                const mediumBadge = stats.medium > 0
                    ? `<span class="badge bg-info">${stats.medium}</span>`
                    : '<span class="text-muted">0</span>';
                const lowBadge = stats.low > 0
                    ? `<span class="badge bg-secondary">${stats.low}</span>`
                    : '<span class="text-muted">0</span>';
                const infoBadge = stats.info > 0
                    ? `<span class="badge bg-light text-dark">${stats.info}</span>`
                    : '<span class="text-muted">0</span>';
                const sastBadge = stats.sast > 0
                    ? `<span class="badge" style="background-color: #39afd1; color: white;">${stats.sast}</span>`
                    : '<span class="text-muted">0</span>';
                const scaBadge = stats.sca > 0
                    ? `<span class="badge bg-warning text-dark">${stats.sca}</span>`
                    : '<span class="text-muted">0</span>';
                const secretsBadge = stats.secrets > 0
                    ? `<span class="badge" style="background-color: #8750de; color: white;">${stats.secrets}</span>`
                    : '<span class="text-muted">0</span>';
                const totalBadge = stats.total > 0
                    ? `<span class="badge bg-secondary">${stats.total}</span>`
                    : '<span class="text-success">0</span>';

                return `
                    <tr>
                        <td><strong>${escapeHtml(manager)}</strong></td>
                        <td class="text-center">${repoCount}</td>
                        <td class="text-center">${criticalBadge}</td>
                        <td class="text-center">${highBadge}</td>
                        <td class="text-center">${mediumBadge}</td>
                        <td class="text-center">${lowBadge}</td>
                        <td class="text-center">${infoBadge}</td>
                        <td class="text-center">${sastBadge}</td>
                        <td class="text-center">${scaBadge}</td>
                        <td class="text-center">${secretsBadge}</td>
                        <td class="text-center">${totalBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderList(containerId, counts, filterType) {
            const container = document.getElementById(containerId);
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            
            container.innerHTML = sorted.map(([name, count]) => {
                const filterParam = encodeURIComponent(name);
                let url;
                
                // Map to correct URL parameters based on filter type
                if (filterType === 'organization') {
                    url = `index.html?orgs=${filterParam}`;
                } else if (filterType === 'pod') {
                    url = `index.html?pods=${filterParam}`;
                } else if (filterType === 'manager') {
                    // Link to index page - users can filter by manager there
                    url = `index.html`;
                } else {
                    url = `index.html`;
                }
                
                return `
                    <div class="info-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="${url}" class="text-decoration-none">
                                <span class="info-value">${escapeHtml(name)}</span>
                            </a>
                            <span class="badge bg-primary">${count}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatLastActivity(dateString) {
            if (!dateString) return '<span class="text-muted" style="font-style: italic;">—</span>';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '<span class="text-muted" style="font-style: italic;">—</span>';
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch {
                return '<span class="text-muted" style="font-style: italic;">—</span>';
            }
        }

        function renderRepositoriesTable() {
            const tbody = document.getElementById('repositoriesTable');
            tbody.innerHTML = verticalRepos.map(repo => {
                const languageBadge = repo.language 
                    ? `<span class="badge bg-info badge-custom">${escapeHtml(repo.language)}</span>`
                    : '';

                const githubUrl = repo.githubUrl || `https://github.com/${repo.organization}/${repo.repository}`;
                
                // Show all pods if multiple exist
                const podsToShow = (repo._allPods && Array.isArray(repo._allPods) && repo._allPods.length > 0) 
                    ? repo._allPods 
                    : (repo.pod && repo.pod !== 'No Pod Selected' ? [repo.pod] : []);
                
                const podsHtml = podsToShow.length > 0
                    ? podsToShow.map(p => `<span class="badge bg-primary badge-custom"><i class="cil-layers" aria-hidden="true"></i> ${escapeHtml(p)}</span>`).join(' ')
                    : '<span class="badge bg-secondary badge-custom" style="opacity: 0.7;"><i class="cil-ban" aria-hidden="true"></i> No Pod Selected</span>';

                // Show all engineering managers from all pods
                const managersToShow = (repo._allManagers && Array.isArray(repo._allManagers) && repo._allManagers.length > 0)
                    ? repo._allManagers
                    : (repo.engineeringManager && repo.engineeringManager.trim() ? [repo.engineeringManager.trim()] : []);
                
                const managersHtml = managersToShow.length > 0
                    ? managersToShow.map(mgr => `<span class="badge bg-warning badge-custom text-dark"><i class="cil-user" aria-hidden="true"></i> ${escapeHtml(mgr)}</span>`).join(' ')
                    : '<span class="badge bg-secondary badge-custom" style="opacity: 0.7;"><i class="cil-ban" aria-hidden="true"></i> No Manager</span>';
                
                // Check for multiple owners
                const hasMultipleOwners = podsToShow.length > 1 || managersToShow.length > 1;
                const multipleOwnersIndicator = hasMultipleOwners 
                    ? '<span class="badge bg-info badge-custom ms-1" title="This repository has multiple owners"><i class="cil-share-all" aria-hidden="true"></i> Shared</span>'
                    : '';
                
                // Render security cell
                const securityHtml = renderSecurityCell(repo);
                
                return `
                    <tr>
                        <td>
                            <span class="badge badge-custom" style="background-color: #6366f1;">
                                <i class="cil-building"></i> ${escapeHtml(repo.organization)}
                            </span>
                        </td>
                        <td>
                            <a href="${githubUrl}" target="_blank" class="repo-link">
                                <i class="cil-code"></i> <strong>${escapeHtml(repo.repository)}</strong>
                            </a>
                            ${multipleOwnersIndicator}
                            ${repo.description ? `<small class="text-muted d-block mt-1">${escapeHtml(repo.description)}</small>` : ''}
                        </td>
                        <td>${podsHtml}</td>
                        <td>${managersHtml}</td>
                        <td>${securityHtml}</td>
                        <td>${formatLastActivity(repo.lastActivity)}</td>
                        <td>${languageBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            document.getElementById('loadingSpinner').innerHTML = `
                <div class="alert alert-danger">
                    <i class="cil-warning"></i> ${escapeHtml(message)}
                </div>
            `;
        }

        function updateBreadcrumbs() {
            const breadcrumbNav = document.getElementById('breadcrumbNav');
            if (!breadcrumbNav || !verticalName) return;

            const breadcrumb = breadcrumbNav.querySelector('.breadcrumb');
            breadcrumb.innerHTML = `
                <li class="breadcrumb-item"><a href="index.html"><i class="cil-home"></i> Home</a></li>
                <li class="breadcrumb-item"><a href="stats.html">Statistics</a></li>
                <li class="breadcrumb-item active">${escapeHtml(verticalName)}</li>
            `;
        }

        // Export functionality
        function exportData(format) {
            if (verticalRepos.length === 0) {
                alert('No data to export');
                return;
            }

            if (format === 'csv') {
                exportCSV();
            } else {
                exportJSON();
            }
        }

        function exportCSV() {
            const headers = ['Organization', 'Repository', 'Pod', 'Vertical', 'Engineering Manager', 'Language', 'Description', 'Last Activity', 'Security Issues', 'SAST Total', 'SAST Critical', 'SAST High', 'SAST Medium', 'SAST Low', 'SAST Info', 'SCA Total', 'SCA Critical', 'SCA High', 'SCA Medium', 'SCA Low', 'SCA Info', 'Secrets Total', 'GitHub URL'];
            const rows = [headers.join(',')];

            verticalRepos.forEach(repo => {
                // Collect all managers for CSV
                const allManagers = (repo._allManagers && Array.isArray(repo._allManagers) && repo._allManagers.length > 0)
                    ? repo._allManagers.join(', ')
                    : (repo.engineeringManager || '');
                // Collect all pods for CSV
                const allPods = (repo._allPods && Array.isArray(repo._allPods) && repo._allPods.length > 0)
                    ? repo._allPods.join(', ')
                    : (repo.pod || '');
                // Collect all verticals for CSV
                const allVerticals = (repo._allVerticals && Array.isArray(repo._allVerticals) && repo._allVerticals.length > 0)
                    ? repo._allVerticals.join(', ')
                    : (repo.vertical || '');
                
                // Collect vulnerability data
                const vulns = repo.vulnerabilities;
                const codeScanning = vulns?.codeScanning || {};
                const dependabot = vulns?.dependabot || {};
                const secretScanning = vulns?.secretScanning || {};
                const totalIssues = (codeScanning.total || 0) + (dependabot.total || 0) + (secretScanning.total || 0);
                
                const row = [
                    repo.organization,
                    repo.repository,
                    allPods,
                    allVerticals,
                    allManagers,
                    repo.language || '',
                    (repo.description || '').replace(/"/g, '""'),
                    repo.lastActivity || '',
                    totalIssues,
                    codeScanning.total || 0,
                    codeScanning.critical || 0,
                    codeScanning.high || 0,
                    codeScanning.medium || 0,
                    codeScanning.low || 0,
                    codeScanning.info || 0,
                    dependabot.total || 0,
                    dependabot.critical || 0,
                    dependabot.high || 0,
                    dependabot.medium || 0,
                    dependabot.low || 0,
                    dependabot.info || 0,
                    secretScanning.total || 0,
                    repo.githubUrl || `https://github.com/${repo.organization}/${repo.repository}`
                ].map(cell => `"${cell}"`);
                rows.push(row.join(','));
            });

            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `repositories_${verticalName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            const data = {
                exported: new Date().toISOString(),
                vertical: verticalName,
                count: verticalRepos.length,
                repositories: verticalRepos
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `repositories_${verticalName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Load verticals for sidebar navigation
        async function loadVerticalsForNav() {
            try {
                const response = await fetch('data/repositories.json');
                const data = await response.json();
                const normalized = normalizeRepositories(data.repositories || []);
                const verticals = [...new Set(normalized.map(r => r.vertical))]
                    .filter(v => v && v !== 'No Vertical Identified')
                    .sort();
                
                const navLinksContainer = document.getElementById('verticalNavLinks');
                if (navLinksContainer) {
                    navLinksContainer.innerHTML = verticals.map(vertical => {
                        const encodedVertical = encodeURIComponent(vertical);
                        const isActive = vertical === verticalName ? 'active' : '';
                        return `
                            <li class="nav-item">
                                <a class="nav-link vertical-link ${isActive}" href="vertical.html?name=${encodedVertical}">
                                    <i class="nav-icon cil-folder"></i> ${escapeHtml(vertical)}
                                </a>
                            </li>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading verticals:', error);
            }
        }

        // Sidebar functionality
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            const sidebarToggle = document.getElementById('sidebarToggle');

            if (window.innerWidth > 768) {
                let isCollapsed = false;
                sidebar.addEventListener('click', (e) => {
                    if (e.target.closest('.nav-link')) {
                        if (window.innerWidth > 768) {
                            isCollapsed = !isCollapsed;
                            if (isCollapsed) {
                                sidebar.classList.remove('sidebar-expanded');
                                sidebar.classList.add('sidebar-minimized');
                                main.classList.add('sidebar-collapsed');
                            } else {
                                sidebar.classList.remove('sidebar-minimized');
                                sidebar.classList.add('sidebar-expanded');
                                main.classList.remove('sidebar-collapsed');
                            }
                        }
                    }
                });
            }

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('show');
                });
            }

            loadVerticalsForNav();
        }

        // Dark mode support
        const darkMode = localStorage.getItem('darkMode') === 'true';
        if (darkMode) {
            document.body.classList.add('dark-mode');
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.innerHTML = '<i class="cil-sun"></i>';
        }

        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', () => {
                const isDark = document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', isDark.toString());
                darkModeToggle.innerHTML = isDark ? '<i class="cil-sun"></i>' : '<i class="cil-moon"></i>';
            });
        }

        // Initialize
        // Quick Lookup functionality
        let allPodsForLookup = [];
        let allManagersForLookup = [];
        let allVerticalsForLookup = [];

        async function initializeQuickLookup() {
            try {
                const res = await fetch('data/pod-managers.yaml');
                if (!res.ok) return;
                const yaml = await res.text();
                const podManagersForLookup = parseSimpleYamlMap(yaml);
                
                const response = await fetch('data/repositories.json');
                const data = await response.json();
                const repos = normalizeRepositories(data.repositories || []);
                
                const pods = new Set();
                const managers = new Set();
                const verticals = new Set();

                repos.forEach(repo => {
                    if (repo._allPods) repo._allPods.forEach(p => pods.add(p));
                    if (repo._allManagers) repo._allManagers.forEach(m => managers.add(m));
                    if (repo._allVerticals) repo._allVerticals.forEach(v => verticals.add(v));
                });

                Object.keys(podManagersForLookup).forEach(pod => pods.add(pod));
                Object.values(podManagersForLookup).forEach(manager => managers.add(manager));

                allPodsForLookup = Array.from(pods).sort();
                allManagersForLookup = Array.from(managers).sort();
                allVerticalsForLookup = Array.from(verticals).sort();
            } catch {}
        }

        function showQuickLookupSuggestions(query) {
            const suggestions = document.getElementById('quickLookupSuggestions');
            if (!suggestions) return;

            if (!query || query.length < 2) {
                suggestions.classList.remove('show');
                return;
            }

            const q = query.toLowerCase();
            const matches = [];

            allPodsForLookup.forEach(pod => {
                if (pod.toLowerCase().includes(q)) {
                    matches.push({ type: 'pod', name: pod, display: pod, icon: 'cil-layers' });
                }
            });

            allManagersForLookup.forEach(manager => {
                if (manager.toLowerCase().includes(q)) {
                    matches.push({ type: 'manager', name: manager, display: manager, icon: 'cil-user' });
                }
            });

            allVerticalsForLookup.forEach(vertical => {
                if (vertical.toLowerCase().includes(q)) {
                    matches.push({ type: 'vertical', name: vertical, display: vertical, icon: 'cil-folder' });
                }
            });

            if (matches.length === 0) {
                suggestions.classList.remove('show');
                return;
            }

            suggestions.innerHTML = matches.slice(0, 10).map(match => `
                <div class="suggestion-item" data-type="${match.type}" data-name="${escapeHtml(match.name)}">
                    <i class="cil ${match.icon} suggestion-icon"></i>
                    <span>${escapeHtml(match.display)}</span>
                </div>
            `).join('');

            suggestions.classList.add('show');

            suggestions.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    const name = item.dataset.name;
                    if (type === 'pod') {
                        window.location.href = `pod.html?name=${encodeURIComponent(name)}`;
                    } else if (type === 'manager') {
                        window.location.href = `manager.html?name=${encodeURIComponent(name)}`;
                    } else if (type === 'vertical') {
                        window.location.href = `vertical.html?name=${encodeURIComponent(name)}`;
                    }
                });
            });
        }

        const quickLookupInput = document.getElementById('quickLookupInput');
        if (quickLookupInput) {
            quickLookupInput.addEventListener('input', (e) => {
                showQuickLookupSuggestions(e.target.value);
            });

            quickLookupInput.addEventListener('blur', () => {
                setTimeout(() => {
                    const suggestions = document.getElementById('quickLookupSuggestions');
                    if (suggestions) suggestions.classList.remove('show');
                }, 200);
            });

            quickLookupInput.addEventListener('focus', (e) => {
                if (e.target.value) {
                    showQuickLookupSuggestions(e.target.value);
                }
            });
        }

        loadData().then(() => {
            initializeQuickLookup();
        });
        initSidebar();
    </script>
</body>
</html>

